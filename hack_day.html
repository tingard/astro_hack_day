<!DOCTYPE html> 
<html> 
<head> 
<meta charset=utf-8>
<title>My first Three.js app</title>
<style> body { margin: 0; } canvas { width: 100%; height: 100% } </style> 
<script style="text/javasript" src="js/PapaParse-4.1.2/papaparse.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r73/three.min.js"></script> 
<script src="http://astronomy.susx.ac.uk/~tl229/astro_hack_day/js/FlyControls.js"></script> 
<script>
	function async(arg, your_function, callback) {
		setTimeout(function() {
			your_function(arg);
			if (callback) {callback();}
		}, 0);
	}

	function coords_to_points(point_list){
		console.log('coords_to_points asyncronously called');
		var geometry = new THREE.BoxGeometry( 1, 1, 1 );
		var point_geometry = new  THREE.Geometry();
		point_geometry.addAttribute( 'position', new THREE.BufferAttribute( new Float32Array(GAMA_pos), 3 ) );

		var material = new THREE.MeshBasicMaterial( { color: 0xffff00 } ); 
		var cube0 = new THREE.Mesh( geometry, material ); 
		scene.add(cube0)

		var point_geometry = new  THREE.Geometry();
		point_geometry.addAttribute( 'position', 
									  new THREE.BufferAttribute( new Float32Array(GAMA_pos), 3 ) );

		for (i=0; i<point_list.length; i++){		
			var vector = new THREE.Vector3(point_list[i][1],
										   point_list[i][2],
										   point_list[i][3]);
			point_geometry.push(vector);
			/*
			var geometry = new THREE.BoxGeometry( .2, .2, .2 );
			var material = new THREE.MeshBasicMaterial( { color: 0xffff00 } ); 
			var cube = new THREE.Mesh( geometry, material ); 
			cube.position.x = point_list[i][1];
			cube.position.y = point_list[i][2];
			cube.position.z = point_list[i][3];
			scene.add( cube );*/
		}
		attributes = {
			size: { type: 'f', value: [] },
			customColor: { type: 'c', value: [] }
		};
		uniforms = {
			color: { type: "c", value: new THREE.Color( 0xFFFFFF ) },
			texture: { type: "t", value: THREE.ImageUtils.loadTexture( "js/threejs/examples/textures/sprites/disc.png" ) }
		};

		var shaderMaterial = new THREE.ShaderMaterial( {
			uniforms: uniforms,
			attributes: attributes,
			vertexShader: document.getElementById( 'vertexshader' ).textContent,
			fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
			alphaTest: 0.9,
		} );

		particles = new THREE.PointCloud( geometry, shaderMaterial );
	}
    
    var foo;
	Papa.parse("http://astronomy.sussex.ac.uk/~tl229/astro_hack_day/cart_WP8_photoz_XMM_LSS.csv", {
		download: true,
		complete: function(results, foo) {
			foo = results.data;
			console.log(foo);
			async(foo, coords_to_points);
		}
	})
	
	function onWindowResize( event ) {
		//SCREEN_HEIGHT = window.innerHeight;
		//SCREEN_WIDTH  = window.innerWidth;
		renderer.setSize(viewportWidth, viewportHeight);
		camera.updateProjectionMatrix();
	}
	
	function onDocumentMouseMove(e) {       
		mouseVector.x = 2 * (e.clientX / containerWidth) - 1;
		mouseVector.y = 1 - 2 * (e.clientY / containerHeight);
		var vector = new THREE.Vector3(mouseVector.x, mouseVector.y, 0.5).unproject(camera);
		raycaster.ray.set(camera.position, vector.sub(camera.position).normalize());
		scene.updateMatrixWorld();
		intersects = raycaster.intersectObject(particles);
		console.log(intersects);
	}
	
	var viewport;

	//built-in three.js controls will be attached to this
	var controls;

	//viewport size
	var viewportWidth = window.innerWidth;
	var viewportHeight = window.innerHeight;

	//camera attributes
	var view_angle = 45,
		aspect = viewportWidth / viewportHeight,
		near = 0.1,//near clip-plane
		far = 100000;//far clip-plane


	//----Constructors----//
	var renderer = new THREE.WebGLRenderer({antialias: true});
	var scene = new THREE.Scene();

	var camera = new THREE.PerspectiveCamera(
	view_angle,
	aspect,
	near,
	far
	);
	
	// need to increase collision detection radius
	
	//a cross-browser method for efficient animation, more info at:
	// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
	window.requestAnimFrame = (function(){
	  return  window.requestAnimationFrame       || 
			  window.webkitRequestAnimationFrame || 
			  window.mozRequestAnimationFrame    || 
			  window.oRequestAnimationFrame      || 
			  window.msRequestAnimationFrame     || 
			  function( callback ){
				window.setTimeout(callback, 1000 / 60);
			  };
	})();
	//----Initialization----//
	function initialize()
	{
		//Sets up the renderer to the same size as a DOM element
		//and attaches it to that element
		renderer.setSize(viewportWidth, viewportHeight);
		viewport = document.getElementById('viewport');
		viewport.appendChild(renderer.domElement);
		camera.position.z=5.;
		//attaches fly controls to the camera
		controls = new THREE.FlyControls( camera );
		//camera control properties
		controls.movementSpeed = .2;
		controls.domElement = viewport;
		controls.rollSpeed = 0.01;
		controls.autoForward = false;
		controls.dragToLook = true;

		//add the objects to the scene
		scene.add(camera);

		// call update
		update();
	}
	//----Update----//
	function update() {
		//requests the browser to call update at it's own pace
		requestAnimFrame( update );

		//update controls
		controls.update( 1 );

		//call draw
		draw();
	}
	//----Draw----//
	function draw() {
		renderer.render(scene, camera);
	}
	window.addEventListener( 'resize', onWindowResize, false );
	window.addEventListener( 'mousemove', onMouseMove, false );

</script> 
</head>
<body onload="initialize();">
<div id="viewport"></div>
</body>
</html>

